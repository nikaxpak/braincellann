# R/annotate_panglaodb.R

#' Annotate Markers with PanglaoDB Database
#'
#' @param df A data frame containing gene markers and an index column.
#' @return A data frame with PanglaoDB annotations.
#' @export
annotate_panglaodb <- function(df) {
  # Load PanglaoDB data using get_resource (assumes this function is defined elsewhere)
  panglaoDB <- get_resource("PanglaoDB")

  if (!is.data.frame(panglaoDB)) {
    stop("PanglaoDB resource could not be retrieved.")
  }

  panglaoDB_filtered <- panglaoDB %>%
    dplyr::filter(
      organ %in% c("Brain", "Immune system", "Vasculature"),
      canonical_marker == TRUE,
      human == TRUE
    ) %>%
    dplyr::rename(markers = genesymbol)

  # Merge and annotate
  merged_df <- merge(df, panglaoDB_filtered, by = "markers", all.x = TRUE) %>%
    arrange(index)

  annotated_panglaodb <- merged_df %>%
    dplyr::group_by(index) %>%
    dplyr::summarise(
      markers = paste(unique(markers), collapse = ", "),
      cell_type = paste(unique(cell_type), collapse = ", ")
    ) %>%
    tidyr::separate(cell_type, into = paste0("PanglaoDB_", 1:2), sep = ", ", fill = "right") %>%
    dplyr::select(-markers, -index)

  return(annotated_panglaodb)
}
