# R/annotate_cellmarker.R

#' Annotate Gene Markers with CellMarker 2.0 Database
#'
#' This function annotates a list of gene markers using the CellMarker 2.0 database.
#'
#' @param df A data frame containing gene markers and an index column.
#' @return A data frame with CellMarker annotations, including columns CellMarker_1 and CellMarker_2.
#'
#' @noRd
annotate_cellmarker <- function(df) {
  # Load CellMarker data from package
  cellmarker_file <- system.file("extdata", "Cell_marker_Human.xlsx", package = "braincellann")

  if (cellmarker_file == "") {
    stop("CellMarker data file not found in the package.")
  }

  cellmarker_db <- readxl::read_excel(cellmarker_file)

  cellmarker_filtered <- cellmarker_db %>%
    dplyr::filter(tissue_class == "Brain") %>%
    dplyr::rename(markers = marker)

  # Merge and annotate
  merged_df <- merge(df, cellmarker_filtered, by = "markers", all.x = TRUE) %>%
    arrange(index)

  annotated_cellmarker <- merged_df %>%
    dplyr::group_by(index) %>%
    dplyr::summarise(
      markers = paste(unique(markers), collapse = ", "),
      cell_name = paste(unique(cell_name), collapse = ", ")
    ) %>%
    tidyr::separate(cell_name, into = paste0("CellMarker_", 1:2), sep = ", ", fill = "right", extra = "merge") %>%
    dplyr::select(-markers, -index)

  # Retain 'index' if needed (if joining later)
  # If 'index' is not needed, ensure it's not required in the main function

  return(annotated_cellmarker)
}

