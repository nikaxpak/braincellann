# R/annotate_bretigea.R

#' Annotate Markers with BRETIGEA Database
#'
#' @param df A data frame containing gene markers and an index column.
#' @return A data frame with BRETIGEA annotations.
#' @export
annotate_bretigea <- function(df) {
  # Load BRETIGEA data from package
  bretigea_file <- system.file("extdata", "markers_df_human_brain.rda", package = "braincellann")

  if (bretigea_file == "") {
    stop("BRETIGEA data file not found in the package.")
  }

  load(bretigea_file)  # Assumes loading 'markers_df_human_brain'

  if (!exists("markers_df_human_brain")) {
    stop("BRETIGEA data not found in the .rda file.")
  }

  bretigea_db <- markers_df_human_brain

  # Merge and annotate
  merged_df <- merge(df, bretigea_db, by = "markers", all.x = TRUE)

  annotated_bretigea <- merged_df %>%
    arrange(index) %>%
    group_by(index) %>%
    summarise(
      markers = paste(unique(markers), collapse = ", "),
      cell = paste(unique(cell), collapse = ", ")
    ) %>%
    separate(cell, into = paste0("Bretigea_", 1:2), sep = ", ", fill = "right")

  return(annotated_bretigea)
}
